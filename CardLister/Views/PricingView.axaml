<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:CardLister.ViewModels"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="CardLister.Views.PricingView"
             x:DataType="vm:PricingViewModel">

    <Grid RowDefinitions="Auto,*,Auto" Margin="24">

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,16">
            <TextBlock Text="Price Cards" FontSize="24" FontWeight="Bold"/>
            <TextBlock IsVisible="{Binding HasCards}">
                <Run Text="Card"/>
                <Run Text="{Binding CurrentPosition}"/>
                <Run Text="of"/>
                <Run Text="{Binding TotalCount}"/>
            </TextBlock>
            <TextBlock Text="{Binding StatusMessage}" Opacity="0.6"
                       IsVisible="{Binding StatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
        </StackPanel>

        <!-- Main Content -->
        <ScrollViewer Grid.Row="1" IsVisible="{Binding HasCards}">
            <StackPanel Spacing="16" MaxWidth="700">

                <!-- Card Info -->
                <Border BorderBrush="{DynamicResource SystemBaseLowColor}" BorderThickness="1"
                        CornerRadius="8" Padding="20">
                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="16">
                        <!-- Card thumbnail -->
                        <Image Grid.Column="0" Source="{Binding CurrentCard.ImagePathFront}"
                               Width="80" MaxHeight="120" Stretch="Uniform"
                               VerticalAlignment="Top"
                               IsVisible="{Binding CurrentCard.ImagePathFront, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                        <StackPanel Grid.Column="1" Spacing="4">
                            <TextBlock Text="{Binding CurrentCard.PlayerName}" FontSize="20" FontWeight="Bold"/>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="{Binding CurrentCard.Year}"/>
                                <TextBlock Text="{Binding CurrentCard.Manufacturer}"/>
                                <TextBlock Text="{Binding CurrentCard.Brand}"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="{Binding CurrentCard.VariationType}" Opacity="0.7"/>
                                <TextBlock Text="{Binding CurrentCard.ParallelName}" Opacity="0.7"/>
                                <TextBlock Text="{Binding CurrentCard.Team}" Opacity="0.7"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,4,0,0">
                                <TextBlock Text="{Binding CurrentCard.CardNumber, StringFormat='#{0}'}"
                                           IsVisible="{Binding CurrentCard.CardNumber, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                <TextBlock Text="{Binding CurrentCard.SerialNumbered}"
                                           IsVisible="{Binding CurrentCard.SerialNumbered, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                           FontWeight="SemiBold"/>
                            </StackPanel>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Automated Price Lookup -->
                <Border BorderBrush="#2980b9" BorderThickness="2"
                        CornerRadius="8" Padding="16" Background="{DynamicResource SystemAltHighColor}">
                    <StackPanel Spacing="12">
                        <TextBlock Text="âš¡ Automated Price Lookup" FontWeight="SemiBold" FontSize="16"/>

                        <TextBlock TextWrapping="Wrap" Opacity="0.8" FontSize="12">
                            Automatically searches 130point.com for recent eBay sold listings.
                            This may take 15+ seconds per card due to rate limiting.
                        </TextBlock>

                        <!-- Button and Loading Indicator -->
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <Button Content="Get Market Price"
                                    Command="{Binding GetMarketPriceCommand}"
                                    IsEnabled="{Binding !IsLookingUpPrice}"
                                    Padding="20,10"
                                    Classes="accent"/>

                            <!-- Loading indicator -->
                            <StackPanel Orientation="Horizontal" Spacing="8"
                                        IsVisible="{Binding IsLookingUpPrice}"
                                        VerticalAlignment="Center">
                                <TextBlock Text="â³" FontSize="18"/>
                                <TextBlock Text="Searching..." VerticalAlignment="Center" FontStyle="Italic"/>
                            </StackPanel>
                        </StackPanel>

                        <!-- Status Message -->
                        <TextBlock Text="{Binding AutomatedStatusMessage}"
                                   IsVisible="{Binding AutomatedStatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                   TextWrapping="Wrap" Opacity="0.9" FontSize="13" FontWeight="SemiBold"/>

                        <!-- Results Display -->
                        <Border IsVisible="{Binding LookupResult.Success}"
                                Background="{DynamicResource SystemChromeLowColor}"
                                Padding="12" CornerRadius="4" BorderThickness="1"
                                BorderBrush="{DynamicResource SystemBaseMediumLowColor}">
                            <StackPanel Spacing="8">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <TextBlock Text="ðŸ’° Median Price:" FontWeight="SemiBold"/>
                                    <TextBlock Text="{Binding LookupResult.MedianPrice, StringFormat='\{0:C2\}', TargetNullValue=''}"
                                               FontSize="18" FontWeight="Bold"
                                               Foreground="#27ae60"/>
                                </StackPanel>

                                <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto" ColumnSpacing="12" RowSpacing="4">
                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Range:" Opacity="0.7"/>
                                    <TextBlock Grid.Row="0" Grid.Column="1" Opacity="0.7">
                                        <Run Text="{Binding LookupResult.LowPrice, StringFormat='\{0:C2\}', TargetNullValue=''}"/>
                                        <Run Text=" - "/>
                                        <Run Text="{Binding LookupResult.HighPrice, StringFormat='\{0:C2\}', TargetNullValue=''}"/>
                                    </TextBlock>

                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Average:" Opacity="0.7"/>
                                    <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding LookupResult.AveragePrice, StringFormat='\{0:C2\}', TargetNullValue=''}" Opacity="0.7"/>

                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Sample Size:" Opacity="0.7"/>
                                    <TextBlock Grid.Row="2" Grid.Column="1" Opacity="0.7">
                                        <Run Text="{Binding LookupResult.SampleSize, TargetNullValue='0'}"/>
                                        <Run Text=" recent sales"/>
                                    </TextBlock>

                                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Confidence:" Opacity="0.7"/>
                                    <TextBlock Grid.Row="3" Grid.Column="1"
                                               Text="{Binding LookupResult.Confidence, TargetNullValue=''}"
                                               Opacity="0.7" FontWeight="SemiBold"/>
                                </Grid>

                                <TextBlock Text="{Binding LookupResult.Source, TargetNullValue=''}"
                                           FontSize="11" Opacity="0.6" FontStyle="Italic" Margin="0,4,0,0"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Border>

                <!-- Divider -->
                <TextBlock Text="OR" HorizontalAlignment="Center"
                           Opacity="0.6" FontWeight="SemiBold" Margin="0,8"/>

                <!-- Manual Research -->
                <TextBlock Text="Manual Research" FontWeight="SemiBold" FontSize="14" Opacity="0.7"/>
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <Button Content="Open Terapeak" Command="{Binding OpenTerapeakCommand}" Padding="16,8"/>
                    <Button Content="Open eBay Sold" Command="{Binding OpenEbaySoldCommand}" Padding="16,8"/>
                </StackPanel>

                <!-- Pricing Fields -->
                <Border BorderBrush="{DynamicResource SystemBaseLowColor}" BorderThickness="1"
                        CornerRadius="8" Padding="20">
                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto" RowSpacing="10" ColumnSpacing="16">
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Market Value ($)" FontWeight="SemiBold"/>
                        <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding MarketValue, TargetNullValue=''}" Watermark="e.g., 15.00"/>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Suggested Price" VerticalAlignment="Center"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding SuggestedPrice, StringFormat='\{0:C2\}', TargetNullValue=''}"
                                   VerticalAlignment="Center" FontWeight="SemiBold"/>

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Listing Price ($)" FontWeight="SemiBold"/>
                        <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding ListingPrice, TargetNullValue=''}" Watermark="Your price"/>

                        <TextBlock Grid.Row="3" Grid.Column="0" Text="Net After Fees" VerticalAlignment="Center"/>
                        <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding NetAfterFees, StringFormat='\{0:C2\}', TargetNullValue=''}"
                                   VerticalAlignment="Center" FontWeight="SemiBold" Foreground="Green"/>

                        <!-- Cost Basis -->
                        <TextBlock Grid.Row="4" Grid.Column="0" Text="Cost Basis ($)"/>
                        <TextBox Grid.Row="4" Grid.Column="1" Text="{Binding CostBasis, TargetNullValue=''}" Watermark="What you paid"/>

                        <TextBlock Grid.Row="5" Grid.Column="0" Text="Cost Notes"/>
                        <TextBox Grid.Row="5" Grid.Column="1" Text="{Binding CostNotes, TargetNullValue=''}" Watermark="Receipt #, etc."/>
                    </Grid>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <!-- No cards message -->
        <TextBlock Grid.Row="1" Text="No unpriced cards. Go scan some cards!"
                   IsVisible="{Binding !HasCards}"
                   HorizontalAlignment="Center" VerticalAlignment="Center"
                   FontSize="16" Opacity="0.5"/>

        <!-- Button Row -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="8"
                    Margin="0,16,0,0" IsVisible="{Binding HasCards}">
            <Button Content="Previous" Command="{Binding PreviousCommand}" Padding="16,8"/>
            <Button Content="Save and Next" Command="{Binding SaveAndNextCommand}"
                    Classes="accent" Padding="20,10"/>
            <Button Content="Skip" Command="{Binding SkipCommand}" Padding="16,8"/>
        </StackPanel>
    </Grid>
</UserControl>
