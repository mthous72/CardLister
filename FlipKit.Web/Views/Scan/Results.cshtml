@model FlipKit.Web.Models.ScanResultViewModel
@using System.IO
@{
    ViewData["Title"] = "Scan Results";
}

<div class="container mt-4">
    <h1 class="display-5 mb-4">
        <i class="bi bi-card-checklist"></i> Review & Edit Scan Results
    </h1>

    @if (Model.VerificationResult != null && Model.VerificationResult.OverallConfidence != FlipKit.Core.Models.Enums.VerificationConfidence.Low)
    {
        <div class="alert @(Model.VerificationResult.OverallConfidence == FlipKit.Core.Models.Enums.VerificationConfidence.High ? "alert-success" :
                             Model.VerificationResult.OverallConfidence == FlipKit.Core.Models.Enums.VerificationConfidence.Medium ? "alert-warning" : "alert-info")">
            <h5>
                <i class="bi bi-check-circle"></i>
                Verification: @Model.VerificationResult.OverallConfidence Confidence
            </h5>
            @if (Model.VerificationResult.ChecklistMatch)
            {
                <p class="mb-0">
                    <strong>Checklist Matched</strong> - Card verified against checklist database
                </p>
            }
            @if (Model.VerificationResult.Suggestions?.Count > 0)
            {
                <p class="mb-0 mt-2"><strong>Suggestions:</strong></p>
                <ul class="mb-0">
                    @foreach (var suggestion in Model.VerificationResult.Suggestions)
                    {
                        <li>@suggestion</li>
                    }
                </ul>
            }
            @if (!string.IsNullOrEmpty(Model.VerificationResult.SuggestedVariation))
            {
                <p class="mb-0 mt-2">
                    <strong>Suggested Variation:</strong> @Model.VerificationResult.SuggestedVariation
                </p>
            }
        </div>
    }

    <div class="row">
        <!-- Left Column: Images -->
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Card Images</h5>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.FrontImagePath))
                    {
                        <h6>Front</h6>
                        <img src="@Url.Content($"~/uploads/{System.IO.Path.GetFileName(Model.FrontImagePath)}")"
                             class="img-fluid mb-3 rounded" alt="Card Front">
                    }
                    @if (!string.IsNullOrEmpty(Model.BackImagePath))
                    {
                        <h6>Back</h6>
                        <img src="@Url.Content($"~/uploads/{System.IO.Path.GetFileName(Model.BackImagePath)}")"
                             class="img-fluid rounded" alt="Card Back">
                    }
                </div>
            </div>
        </div>

        <!-- Right Column: Editable Form -->
        <div class="col-md-8">
            @if (Model.ScannedCard != null)
            {
                <form asp-action="ResearchComps" method="post" id="scanForm">
                    @Html.AntiForgeryToken()

                    <!-- Hidden fields for non-essential properties -->
                    <input type="hidden" asp-for="ScannedCard.Id" />
                    <input type="hidden" asp-for="ScannedCard.Status" />
                    <input type="hidden" name="frontImagePath" value="@Model.FrontImagePath" />
                    <input type="hidden" name="backImagePath" value="@Model.BackImagePath" />
                    <input type="hidden" asp-for="ScannedCard.Condition" />
                    <input type="hidden" asp-for="ScannedCard.Manufacturer" />
                    <input type="hidden" asp-for="ScannedCard.CertNumber" />
                    <input type="hidden" asp-for="ScannedCard.AutoGrade" />
                    <input type="hidden" asp-for="ScannedCard.IsShortPrint" />
                    <input type="hidden" asp-for="ScannedCard.IsSSP" />

                    <!-- Section 1: Basic Information -->
                    <div class="card mb-3">
                        <div class="card-header"><h5>Basic Information</h5></div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Player Name *</label>
                                    <input type="text" class="form-control" asp-for="ScannedCard.PlayerName" required />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Sport</label>
                                    <select class="form-select" asp-for="ScannedCard.Sport" asp-items="Html.GetEnumSelectList<FlipKit.Core.Models.Enums.Sport>()"></select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Year</label>
                                    <input type="number" class="form-control" asp-for="ScannedCard.Year" min="1900" max="2100" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Brand</label>
                                    <input type="text" class="form-control" asp-for="ScannedCard.Brand" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Set Name</label>
                                    <input type="text" class="form-control" asp-for="ScannedCard.SetName" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Card Number</label>
                                    <input type="text" class="form-control" asp-for="ScannedCard.CardNumber" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Team</label>
                                    <input type="text" class="form-control" asp-for="ScannedCard.Team" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Card Features -->
                    <div class="card mb-3">
                        <div class="card-header"><h5>Card Features</h5></div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" asp-for="ScannedCard.IsRookie" />
                                        <label class="form-check-label" asp-for="ScannedCard.IsRookie">Rookie Card</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" asp-for="ScannedCard.IsAuto" />
                                        <label class="form-check-label" asp-for="ScannedCard.IsAuto">Autograph</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" asp-for="ScannedCard.IsRelic" />
                                        <label class="form-check-label" asp-for="ScannedCard.IsRelic">Relic/Memorabilia</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: Grading Info -->
                    <div class="card mb-3">
                        <div class="card-header"><h5>Grading</h5></div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" asp-for="ScannedCard.IsGraded" id="isGradedCheckbox" />
                                <label class="form-check-label" asp-for="ScannedCard.IsGraded">Professionally Graded</label>
                            </div>
                            <div id="gradingFields" style="display: @(Model.ScannedCard.IsGraded ? "block" : "none")">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Grade Company</label>
                                        <input type="text" class="form-control" asp-for="ScannedCard.GradeCompany" placeholder="PSA, BGS, CGC, etc." />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Grade Value</label>
                                        <input type="text" class="form-control" asp-for="ScannedCard.GradeValue" placeholder="10, 9.5, etc." />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 4: Variation & Parallel -->
                    <div class="card mb-3">
                        <div class="card-header"><h5>Variation & Parallel</h5></div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Variation Type</label>
                                    <input type="text" class="form-control" asp-for="ScannedCard.VariationType" placeholder="Base, Image Variation, etc." />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Parallel Name</label>
                                    <input type="text" class="form-control" asp-for="ScannedCard.ParallelName" placeholder="Silver, Gold, Orange, etc." />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Serial Numbered</label>
                                    <input type="text" class="form-control" asp-for="ScannedCard.SerialNumbered" placeholder="/99, /10, etc." />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mode Toggle -->
                    <div class="mb-3">
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="scanMode" id="buyingMode" value="buying" @(Model.ScanMode == "buying" ? "checked" : "")>
                            <label class="btn btn-outline-primary" for="buyingMode">
                                <i class="bi bi-cart"></i> Buying (Research)
                            </label>
                            <input type="radio" class="btn-check" name="scanMode" id="sellingMode" value="selling" @(Model.ScanMode == "selling" ? "checked" : "")>
                            <label class="btn btn-outline-success" for="sellingMode">
                                <i class="bi bi-database"></i> Selling (Catalog)
                            </label>
                        </div>
                        <small class="text-muted d-block mt-2 text-center">
                            Change mode to adjust available actions
                        </small>
                    </div>

                    <!-- Action Buttons (dynamic based on mode) -->
                    <div class="d-grid gap-2" id="actionButtons">
                        <!-- Buying mode (default if buying) -->
                        <button type="submit" formaction="@Url.Action("ResearchComps", "Scan")" class="btn btn-primary btn-lg buying-mode" style="display: @(Model.ScanMode == "buying" ? "block" : "none")">
                            <i class="bi bi-graph-up"></i> Research Comps
                        </button>
                        <button type="submit" formaction="@Url.Action("Save", "Scan")" class="btn btn-outline-success buying-mode" style="display: @(Model.ScanMode == "buying" ? "block" : "none")">
                            <i class="bi bi-save"></i> Save to Inventory
                        </button>

                        <!-- Selling mode (default if selling) -->
                        <button type="submit" formaction="@Url.Action("Save", "Scan")" class="btn btn-success btn-lg selling-mode" style="display: @(Model.ScanMode == "selling" ? "block" : "none")">
                            <i class="bi bi-save"></i> Save Card
                        </button>
                        <div class="row selling-mode" style="display: @(Model.ScanMode == "selling" ? "flex" : "none")">
                            <div class="col-6">
                                <button type="submit" formaction="@Url.Action("ResearchComps", "Scan")" class="btn btn-outline-primary w-100">
                                    <i class="bi bi-graph-up"></i> Research Comps
                                </button>
                            </div>
                            <div class="col-6">
                                <button type="submit" formaction="@Url.Action("SaveAndResearch", "Scan")" class="btn btn-outline-success w-100">
                                    <i class="bi bi-save-fill"></i> Save & Research
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Secondary Actions -->
                    <div class="d-flex justify-content-between mt-3">
                        <a asp-action="Index" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Scan Another
                        </a>
                        <form asp-action="Discard" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-outline-danger">
                                <i class="bi bi-trash"></i> Discard
                            </button>
                        </form>
                    </div>
                </form>
            }
            else
            {
                <div class="alert alert-warning">
                    <h5>No Scan Data</h5>
                    <p>Unable to retrieve scan results. Please try scanning again.</p>
                    <a asp-action="Index" class="btn btn-primary">Scan New Card</a>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Toggle button visibility based on mode
        document.querySelectorAll('input[name="scanMode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const buyingElements = document.querySelectorAll('.buying-mode');
                const sellingElements = document.querySelectorAll('.selling-mode');

                if (this.value === 'buying') {
                    buyingElements.forEach(el => el.style.display = el.tagName === 'DIV' ? 'block' : 'block');
                    sellingElements.forEach(el => el.style.display = 'none');
                } else {
                    buyingElements.forEach(el => el.style.display = 'none');
                    sellingElements.forEach(el => el.style.display = el.tagName === 'DIV' ? 'flex' : 'block');
                }
            });
        });

        // Show/hide grading fields based on checkbox
        document.getElementById('isGradedCheckbox').addEventListener('change', function() {
            document.getElementById('gradingFields').style.display = this.checked ? 'block' : 'none';
        });
    </script>
}
